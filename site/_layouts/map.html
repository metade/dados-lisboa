---
layout: nil
---

<!doctype html>
<html lang="pt">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>{{ page.title }} | {{ site.title }}</title>
        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
        />
        <link
            rel="stylesheet"
            href="{{ '/assets/css/theme.css' | relative_url }}"
        />
        <link
            rel="stylesheet"
            href="{{ '/assets/css/site.css' | relative_url }}"
        />
        <link
            href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css"
            rel="stylesheet"
        />
        <!-- Bootstrap Icons -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
            rel="stylesheet"
        />
    </head>
    <body>
        <div id="map" class="map-full position-relative"></div>

        <!-- External libraries - use versions known to work well with Firefox -->
        <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>
        <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

        <!-- Firefox debugging for PMTiles -->
        <script>
            console.log("Browser:", navigator.userAgent);
            console.log(
                "PMTiles version:",
                typeof pmtiles !== "undefined" ? "loaded" : "not loaded",
            );
            console.log(
                "MapLibre version:",
                typeof maplibregl !== "undefined" ? "loaded" : "not loaded",
            );
        </script>

        <!-- Core scripts -->
        <script
            type="module"
            src="{{ '/assets/js/core.js' | relative_url }}"
        ></script>

        <!-- Base map initialization -->
        <script type="module">
            import { initMap } from "{{ '/assets/js/map.js' | relative_url }}";

            const basemap = {
                mode: "{{ site.basemap.mode | default: 'carto_raster' }}",
                pmtilesPath: "{{ site.basemap.pmtiles_path | default: '/assets/data/processed/basemap.pmtiles' | relative_url }}",
                carto: {
                    rasterSubdomains: {{ site.basemap.carto.raster_subdomains | jsonify }},
                    rasterPath: "{{ site.basemap.carto.raster_path }}",
                    vectorStyleURL: "{{ site.basemap.carto.vector_style_url }}",
                    attribution: "{{ site.basemap.carto.attr }}"
                }
            };

            try {
                window.map = initMap({
                    container: 'map',
                    center: [-9.1427, 38.7369],
                    zoom: 12,
                    basemap
                });

                // Add error debugging
                window.map.on('error', (e) => {
                    console.error('MapLibre error:', e);
                    if (e.error?.message?.includes('Decoding failed')) {
                        console.error('Vector tile decoding failed in Firefox - PMTiles issue');
                        console.error('Error details:', e.error);
                        console.error('Source:', e.sourceId);
                        console.error('Tile:', e.tile);
                    }
                });

                // Dispatch event when map is ready
                window.map.on('load', () => {
                    console.log('Map loaded successfully');
                    window.dispatchEvent(new CustomEvent('mapReady', { detail: window.map }));
                });

            } catch (error) {
                console.error('Map initialization failed:', error);
                document.getElementById('map').innerHTML =
                    '<div class="alert alert-danger m-3">Erro ao inicializar o mapa. Verifique o console para detalhes.</div>';
            }
        </script>

        <!-- Bootstrap JS -->
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"
        ></script>

        <!-- Page-specific content and scripts -->
        {{ content }}
    </body>
</html>
