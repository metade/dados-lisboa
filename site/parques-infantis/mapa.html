---
layout: map
title: "Parques Infantis"
---

<!-- Bootstrap Offcanvas Trigger Button -->
<button
    class="btn btn-primary position-fixed"
    style="top: 20px; right: 20px; z-index: 1000"
    type="button"
    data-bs-toggle="offcanvas"
    data-bs-target="#sidePanel"
    aria-controls="sidePanel"
>
    <i class="bi bi-list me-2"></i>Parques Infantis
</button>

<!-- Bootstrap Offcanvas Side Panel -->
<div
    class="offcanvas offcanvas-end"
    tabindex="-1"
    id="sidePanel"
    aria-labelledby="sidePanelLabel"
    style="width: 400px"
>
    <div class="offcanvas-header bg-light">
        <h5 class="offcanvas-title" id="sidePanelLabel">
            Informação e Filtros
        </h5>
        <button
            type="button"
            class="btn-close"
            data-bs-dismiss="offcanvas"
            aria-label="Close"
        ></button>
    </div>
    <div class="offcanvas-body">
        <!-- About Section -->
        <div class="mb-4">
            <h6 class="fw-bold mb-3">Sobre a Visualização</h6>
            <p class="small text-muted">
                Este mapa mostra os parques infantis de Lisboa e a sua
                proximidade a quiosques. As áreas residenciais estão coloridas
                por distância ao parque mais próximo.
            </p>
        </div>

        <!-- Legend Section -->
        <div class="mb-4">
            <h6 class="fw-bold mb-3">Legenda</h6>

            <div class="mb-3">
                <h6 class="fs-6 fw-semibold mb-2">
                    Distancia de parques infantis
                </h6>
                <div class="d-flex align-items-center mb-2">
                    <div
                        class="me-2"
                        style="
                            width: 20px;
                            height: 15px;
                            background-color: #27ae60;
                        "
                    ></div>
                    <small>< 200m do parque</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div
                        class="me-2"
                        style="
                            width: 20px;
                            height: 15px;
                            background-color: #f1c40f;
                        "
                    ></div>
                    <small>200-400m do parque</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div
                        class="me-2"
                        style="
                            width: 20px;
                            height: 15px;
                            background-color: #e74c3c;
                        "
                    ></div>
                    <small>400-1000m do parque</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div
                        class="me-2"
                        style="
                            width: 20px;
                            height: 15px;
                            background-color: #9b59b6;
                        "
                    ></div>
                    <small>> 1000m do parque</small>
                </div>
            </div>

            <div class="mb-3">
                <h6 class="fs-6 fw-semibold mb-2">
                    Gestão dos parques infantis
                </h6>
                <div class="d-flex align-items-center mb-2">
                    <div
                        class="me-2 rounded-circle"
                        style="
                            width: 15px;
                            height: 15px;
                            background-color: #e74c3c;
                        "
                    ></div>
                    <small>Parques JF (Junta de Freguesia)</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div
                        class="me-2 rounded-circle"
                        style="
                            width: 15px;
                            height: 15px;
                            background-color: #3498db;
                        "
                    ></div>
                    <small>Parques CML (Câmara Municipal)</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div
                        class="me-2 rounded-circle"
                        style="
                            width: 15px;
                            height: 15px;
                            background-color: #95a5a6;
                        "
                    ></div>
                    <small>Parques outros</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <span class="me-2 fw-bold">*</span>
                    <small>Quiosque próximo</small>
                </div>
            </div>
        </div>

        <!-- Children Density Section -->
        <div class="mb-4">
            <h6 class="fw-bold mb-3">Densidade de Crianças</h6>
            <div class="d-flex align-items-center mb-2">
                <div
                    class="me-2"
                    style="
                        width: 20px;
                        height: 15px;
                        background-color: #27ae60;
                        opacity: 0.1;
                    "
                ></div>
                <small>Poucas crianças</small>
            </div>
            <div class="d-flex align-items-center mb-2">
                <div
                    class="me-2"
                    style="
                        width: 20px;
                        height: 15px;
                        background-color: #f1c40f;
                        opacity: 0.4;
                    "
                ></div>
                <small>Algumas crianças</small>
            </div>
            <div class="d-flex align-items-center mb-2">
                <div
                    class="me-2"
                    style="
                        width: 20px;
                        height: 15px;
                        background-color: #e74c3c;
                        opacity: 0.7;
                    "
                ></div>
                <small>Muitas crianças</small>
            </div>
            <p class="small text-muted mt-2">
                A intensidade da cor indica o número de crianças (&lt; 14 anos)
                por hexágono.
            </p>
        </div>

        <!-- Filters Section -->
        <div class="mb-4">
            <h6 class="fw-bold mb-3">Filtros</h6>

            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">Freguesias</h6>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            id="select-all-freguesias"
                            checked
                        />
                        <label
                            class="form-check-label fw-semibold"
                            for="select-all-freguesias"
                        >
                            Selecionar todas
                        </label>
                    </div>
                    <div
                        id="freguesias-filter"
                        class="overflow-auto"
                        style="max-height: 200px"
                    >
                        <!-- Freguesia checkboxes will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { singleClickPerFeature } from "/assets/js/core.js";

    window.addEventListener("mapReady", (event) => {
        const map = event.detail;

        // Register PMTiles protocol (needed when adding sources manually)
        if (!maplibregl.getProtocol || !maplibregl.getProtocol("pmtiles")) {
            console.log("registering PMTiles protocol");
            const protocol = new pmtiles.Protocol();
            maplibregl.addProtocol("pmtiles", protocol.tile);
        }

        const pmtilesURL =
            "{{ '/assets/data/processed/parques_infantis.pmtiles' | relative_url }}";
        const abs = new URL(pmtilesURL, window.location.origin);
        const thematicURL = "pmtiles://" + abs.pathname + abs.search;

        // Add the PMTiles source (contains both playgrounds and H3 data)
        map.addSource("playgrounds", {
            type: "vector",
            url: thematicURL,
        });

        // Check if we have URL parameters to set initial filter
        const urlFreguesias = getSelectedFreguesiasFromURL();

        // Add H3 hexagon layer with distance-based colors and children-based opacity
        map.addLayer({
            id: "h3-hexagons",
            type: "fill",
            source: "playgrounds", // Using the same source
            "source-layer": "h3", // H3 layer within the PMTiles file
            paint: {
                "fill-color": [
                    "case",
                    ["<", ["get", "nearest_playground_distance"], 200],
                    "#27ae60", // Green for < 200m
                    ["<", ["get", "nearest_playground_distance"], 400],
                    "#f1c40f", // Yellow for 200-400m
                    ["<", ["get", "nearest_playground_distance"], 1000],
                    "#e74c3c", // Red for 400-1000m
                    "#9b59b6", // Purple for > 1000m
                ],
                "fill-opacity": [
                    "case",
                    ["==", ["get", "children_under_14"], 0],
                    0, // Transparent when 0 children
                    [
                        "interpolate",
                        ["linear"],
                        ["get", "children_under_14"],
                        1,
                        0.1, // Minimum opacity for 1 child
                        100,
                        0.7, // Adjust this max value based on your actual data
                    ],
                ],
                "fill-outline-color": "#ffffff",
            },
        });

        // Apply initial filter after layer is created
        if (urlFreguesias.length > 0) {
            const initialFilter = [
                "any",
                ...urlFreguesias.map((freguesia) => [
                    "in",
                    freguesia,
                    ["get", "freguesias"],
                ]),
            ];
            map.setFilter("h3-hexagons", initialFilter);
        }
        // If no URL params, layer will show all by default (no filter needed)

        // Add playgrounds layer with color based on gestao
        map.addLayer({
            id: "playgrounds",
            type: "circle",
            source: "playgrounds",
            "source-layer": "parques_infantis",
            paint: {
                "circle-radius": [
                    "case",
                    ["==", ["get", "quiosque_proximos"], 1],
                    8, // Larger radius for playgrounds with nearby kiosks
                    6, // Default radius
                ],
                "circle-color": [
                    "case",
                    ["==", ["get", "gestao"], "JF"],
                    "#e74c3c", // Red for JF
                    ["==", ["get", "gestao"], "CML"],
                    "#3498db", // Blue for CML
                    "#95a5a6", // Gray for others
                ],
                "circle-stroke-width": 1,
                "circle-stroke-color": "#ffffff",
            },
        });

        // Add symbol layer for playgrounds with nearby kiosks
        map.addLayer({
            id: "playgrounds-with-kiosks",
            type: "symbol",
            source: "playgrounds",
            "source-layer": "parques_infantis",
            filter: [
                "all",
                ["has", "distance_from_quiosque"],
                ["<", ["get", "distance_from_quiosque"], 100],
            ],
            layout: {
                "text-field": "*",
                "text-font": ["Open Sans Bold", "Arial Unicode MS Bold"],
                "text-size": 14,
                "text-offset": [0, 0.1],
                "text-anchor": "center",
            },
            paint: {
                "text-color": "#FFFFFF",
                "text-halo-color": [
                    "case",
                    ["==", ["get", "gestao"], "JF"],
                    "#e74c3c", // Red for JF
                    ["==", ["get", "gestao"], "CML"],
                    "#3498db", // Blue for CML
                    "#95a5a6", // Gray for others
                ],
                "text-halo-width": 2,
                "text-opacity": 1,
            },
        });

        // Add click event for playgrounds
        async function handlePlaygroundClick(e, feature) {
            // Stop event propagation to prevent hexagon popup from also showing
            e.preventDefault();

            const properties = e.features[0].properties;
            const coordinates = e.features[0].geometry.coordinates.slice();

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            const gestaoLabel =
                properties.gestao === "JF"
                    ? "Junta de Freguesia"
                    : properties.gestao === "CML"
                      ? "Câmara Municipal"
                      : "Outro";

            const quiosqueText =
                properties.quiosque_proximos === 1 ? "Sim" : "Não";

            new maplibregl.Popup()
                .setLngLat(coordinates)
                .setHTML(
                    `
                    <div class="playground-popup">
                        <h6 class="fw-bold mb-2">${properties.designacao || properties.nome || "Parque Infantil"}</h6>
                        ${properties.morada ? `<p class="mb-1 small"><strong>Morada:</strong> ${properties.morada}</p>` : ""}
                        <p class="mb-1 small"><strong>Gestão:</strong> ${gestaoLabel}</p>
                        ${properties.servico_cml ? `<p class="mb-1 small"><strong>Serviço CML:</strong> ${properties.servico_cml}</p>` : ""}
                        <p class="mb-1 small"><strong>Quiosque próximo:</strong> ${quiosqueText}</p>
                        ${properties.freguesia ? `<p class="mb-0 small"><strong>Freguesia:</strong> ${properties.freguesia}</p>` : ""}
                    </div>
                `,
                )
                .addTo(map);
        }

        map.on(
            "click",
            "playgrounds",
            singleClickPerFeature(
                handlePlaygroundClick,
                (feature) => feature.id,
            ),
        );

        // Change the cursor to a pointer when the mouse is over the playgrounds layer
        map.on("mouseenter", "playgrounds", () => {
            map.getCanvas().style.cursor = "pointer";
        });

        // Change it back to a pointer when it leaves
        map.on("mouseleave", "playgrounds", () => {
            map.getCanvas().style.cursor = "";
        });

        // Add click event for H3 hexagons
        async function handleH3Click(e, feature) {
            // Check if we clicked on a playground feature at the same location
            const playgroundFeatures = map.queryRenderedFeatures(e.point, {
                layers: ["playgrounds"],
            });

            // If there's a playground at this location, don't show hexagon popup
            if (playgroundFeatures.length > 0) {
                return;
            }

            const properties = e.features[0].properties;
            const coordinates = e.lngLat;

            const distance = Math.round(properties.nearest_playground_distance);
            const children = properties.children_under_14 || 0;
            const playgroundCount = properties.playground_count || 0;

            new maplibregl.Popup()
                .setLngLat(coordinates)
                .setHTML(
                    `
                    <div class="h3-popup">
                        <h6 class="fw-bold mb-2">Informação da Área</h6>
                        <p class="mb-1 small"><strong>Distância ao parque mais próximo:</strong> ${distance}m</p>
                        <p class="mb-1 small"><strong>Número de parques:</strong> ${playgroundCount}</p>
                        <p class="mb-0 small"><strong>Crianças (&lt;14 anos):</strong> ${children}</p>
                    </div>
                `,
                )
                .addTo(map);
        }

        map.on(
            "click",
            "h3-hexagons",
            singleClickPerFeature(handleH3Click, (feature) => feature.id),
        );

        // Populate freguesias filter after data loads
        let hasInitialized = false;
        map.on("sourcedata", (e) => {
            if (
                e.sourceId === "playgrounds" &&
                e.isSourceLoaded &&
                !hasInitialized
            ) {
                hasInitialized = true;

                setTimeout(() => {
                    populateFreguesiasFilter();

                    // Check for URL parameters
                    const urlFreguesias = getSelectedFreguesiasFromURL();
                    if (urlFreguesias.length > 0) {
                        // Just zoom to the already-filtered areas and update UI
                        setTimeout(() => {
                            // Set checkbox states to match URL selection
                            const checkboxes = document.querySelectorAll(
                                '#freguesias-filter input[type="checkbox"]',
                            );
                            checkboxes.forEach((cb) => {
                                cb.checked = urlFreguesias.includes(cb.value);
                            });
                            updateSelectAllCheckbox();
                            zoomToSelectedFreguesias();
                            updateURLWithFreguesias();
                        }, 100);
                    }
                    // If no URL params, hexagons will show all by default (no filter)
                }, 500);
            }
        });

        // Add event listeners
        document
            .getElementById("select-all-freguesias")
            .addEventListener("change", onSelectAllChange);
    });

    // Freguesias filter functions
    function populateFreguesiasFilter() {
        try {
            // Query H3 features to get unique freguesias
            const features = window.map.querySourceFeatures("playgrounds", {
                sourceLayer: "h3",
            });

            console.log("Total H3 features found:", features.length);

            // Extract freguesias from H3 features
            const freguesiasSet = new Set();
            features.forEach((feature) => {
                const value = feature.properties.freguesias;
                if (value) {
                    if (Array.isArray(value)) {
                        // If it's an array, add each freguesia
                        value.forEach((f) => freguesiasSet.add(f));
                    } else if (typeof value === "string") {
                        try {
                            // Try to parse as JSON array
                            const parsed = JSON.parse(value);
                            if (Array.isArray(parsed)) {
                                parsed.forEach((f) => freguesiasSet.add(f));
                            } else {
                                freguesiasSet.add(value);
                            }
                        } catch (e) {
                            // Not JSON, treat as single string
                            freguesiasSet.add(value);
                        }
                    } else {
                        freguesiasSet.add(value.toString());
                    }
                }
            });

            const freguesias = Array.from(freguesiasSet).sort();

            console.log("Unique freguesias found:", freguesias);

            if (freguesias.length === 0) {
                console.warn("No freguesias found in features");
                console.log(
                    "Available properties in first feature:",
                    features.length > 0
                        ? Object.keys(features[0].properties)
                        : "No features found",
                );
                const container = document.getElementById("freguesias-filter");
                container.innerHTML =
                    '<div class="alert alert-warning small" role="alert">Nenhuma freguesia encontrada nos dados. Verifique os logs do console para mais detalhes.</div>';
                return;
            }

            const container = document.getElementById("freguesias-filter");
            container.innerHTML = "";

            // Check if we have URL parameters to determine default checked state
            const urlFreguesias = getSelectedFreguesiasFromURL();
            const defaultChecked = urlFreguesias.length === 0;

            freguesias.forEach((freguesia) => {
                const div = document.createElement("div");
                div.className = "form-check mb-2";

                const checkbox = document.createElement("input");
                checkbox.className = "form-check-input";
                checkbox.type = "checkbox";
                checkbox.id = `freguesia-${freguesia.replace(/\s+/g, "-").replace(/[^a-zA-Z0-9-]/g, "")}`;
                checkbox.value = freguesia;
                checkbox.checked =
                    defaultChecked || urlFreguesias.includes(freguesia);
                checkbox.addEventListener("change", onFreguesiasChange);

                const label = document.createElement("label");
                label.className = "form-check-label small";
                label.htmlFor = checkbox.id;
                label.textContent = freguesia;

                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });

            updateSelectAllCheckbox();

            // No need to set filter for "show all" case - layer shows all by default
        } catch (error) {
            console.error("Error populating freguesias filter:", error);
            const container = document.getElementById("freguesias-filter");
            container.innerHTML =
                '<div class="alert alert-danger small" role="alert">Erro ao carregar freguesias: ' +
                error.message +
                "</div>";
        }
    }

    function updateSelectAllCheckbox() {
        const checkboxes = document.querySelectorAll(
            '#freguesias-filter input[type="checkbox"]',
        );
        const selectAllCheckbox = document.getElementById(
            "select-all-freguesias",
        );

        const checkedCount = Array.from(checkboxes).filter(
            (cb) => cb.checked,
        ).length;
        const totalCount = checkboxes.length;

        if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === totalCount) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    function onFreguesiasChange() {
        console.log("onFreguesiasChange called");
        updateSelectAllCheckbox();

        // Add a small delay to ensure DOM is updated
        setTimeout(() => {
            applyFreguesiasFilter();
            updateURLWithFreguesias();
        }, 10);
    }

    function onSelectAllChange() {
        console.log("onSelectAllChange called");
        const selectAllCheckbox = document.getElementById(
            "select-all-freguesias",
        );
        const checkboxes = document.querySelectorAll(
            '#freguesias-filter input[type="checkbox"]',
        );

        console.log("Select all checked:", selectAllCheckbox.checked);
        console.log("Number of individual checkboxes:", checkboxes.length);

        checkboxes.forEach((checkbox) => {
            checkbox.checked = selectAllCheckbox.checked;
        });

        selectAllCheckbox.indeterminate = false;

        // Add a small delay to ensure DOM is updated
        setTimeout(() => {
            applyFreguesiasFilter();
            updateURLWithFreguesias();
        }, 10);
    }

    function applyFreguesiasFilter() {
        const selectedFreguesias = Array.from(
            document.querySelectorAll(
                '#freguesias-filter input[type="checkbox"]:checked',
            ),
        ).map((cb) => cb.value);

        const totalFreguesias = getAllFreguesias().length;

        console.log("applyFreguesiasFilter called");
        console.log("DOM query found selected freguesias:", selectedFreguesias);
        console.log("Number of selected:", selectedFreguesias.length);
        console.log("Total freguesias:", totalFreguesias);

        if (selectedFreguesias.length === 0) {
            // Hide all hexagons when no freguesias selected
            console.log("Hiding all hexagons - no freguesias selected");
            if (window.map.getLayer("h3-hexagons")) {
                window.map.setFilter("h3-hexagons", [
                    "==",
                    ["literal", true],
                    false,
                ]);
            }
        } else if (
            selectedFreguesias.length === totalFreguesias &&
            totalFreguesias > 0
        ) {
            // Show all hexagons when all freguesias selected
            console.log("Showing all hexagons - all freguesias selected");
            if (window.map.getLayer("h3-hexagons")) {
                window.map.setFilter("h3-hexagons", null);
            }
        } else {
            // Show selected freguesias using string-based filtering
            console.log(
                "Applying partial filter for",
                selectedFreguesias.length,
                "freguesias",
            );
            const filter = [
                "any",
                ...selectedFreguesias.map((freguesia) => [
                    "in",
                    freguesia,
                    ["get", "freguesias"],
                ]),
            ];
            if (window.map.getLayer("h3-hexagons")) {
                window.map.setFilter("h3-hexagons", filter);
            }
            console.log(
                `Applied filter for freguesias: ${selectedFreguesias.join(", ")}`,
            );
        }

        // Always keep playgrounds visible
        window.map.setFilter("playgrounds", null);
        window.map.setFilter("playgrounds-with-kiosks", [
            "all",
            ["has", "distance_from_quiosque"],
            ["<", ["get", "distance_from_quiosque"], 100],
        ]);

        updateChildrenLegend();
        zoomToSelectedFreguesias();
    }

    function zoomToSelectedFreguesias() {
        const selectedFreguesias = Array.from(
            document.querySelectorAll(
                '#freguesias-filter input[type="checkbox"]:checked',
            ),
        ).map((cb) => cb.value);

        // Don't zoom if all freguesias are selected (show full map)
        if (
            selectedFreguesias.length === 0 ||
            selectedFreguesias.length === getAllFreguesias().length
        ) {
            return;
        }

        try {
            // Get all H3 features
            const allFeatures = window.map.querySourceFeatures("playgrounds", {
                sourceLayer: "h3",
            });

            // Filter features client-side to find matching hexagons
            const matchingFeatures = allFeatures.filter((feature) => {
                const freguesias = feature.properties.freguesias;
                if (!freguesias) return false;

                if (Array.isArray(freguesias)) {
                    return freguesias.some((f) =>
                        selectedFreguesias.includes(f),
                    );
                } else if (typeof freguesias === "string") {
                    try {
                        const parsed = JSON.parse(freguesias);
                        if (Array.isArray(parsed)) {
                            return parsed.some((f) =>
                                selectedFreguesias.includes(f),
                            );
                        } else {
                            return selectedFreguesias.includes(freguesias);
                        }
                    } catch (e) {
                        return selectedFreguesias.includes(freguesias);
                    }
                }
                return false;
            });

            if (matchingFeatures.length === 0) {
                console.log("No matching features found for zoom");
                return;
            }

            const bounds = new maplibregl.LngLatBounds();
            matchingFeatures.forEach((feature) => {
                if (feature.geometry.type === "Polygon") {
                    feature.geometry.coordinates[0].forEach((coord) => {
                        bounds.extend(coord);
                    });
                } else if (feature.geometry.type === "MultiPolygon") {
                    feature.geometry.coordinates.forEach((polygon) => {
                        polygon[0].forEach((coord) => {
                            bounds.extend(coord);
                        });
                    });
                }
            });

            window.map.fitBounds(bounds, {
                padding: 50,
                duration: 1000,
                essential: false,
            });

            console.log(
                `Zoomed to ${matchingFeatures.length} matching hexagons`,
            );
        } catch (error) {
            console.warn("Could not zoom to selected freguesias:", error);
        }
    }

    function updateChildrenLegend() {
        // This function can be expanded to update legend based on visible data
        // For now, it's a placeholder for future enhancements
    }

    function getSelectedFreguesiasFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const freguesias = urlParams.get("freguesias");
        return freguesias ? freguesias.split(",") : [];
    }

    function updateURLWithFreguesias() {
        const selectedFreguesias = Array.from(
            document.querySelectorAll(
                '#freguesias-filter input[type="checkbox"]:checked',
            ),
        ).map((cb) => cb.value);

        const url = new URL(window.location);
        if (selectedFreguesias.length > 0) {
            url.searchParams.set("freguesias", selectedFreguesias.join(","));
        } else {
            url.searchParams.delete("freguesias");
        }

        window.history.replaceState({}, "", url);
    }

    function getAllFreguesias() {
        const checkboxes = document.querySelectorAll(
            '#freguesias-filter input[type="checkbox"]',
        );
        return Array.from(checkboxes).map((cb) => cb.value);
    }
</script>

<style>
    /* Custom styles to override Bootstrap where needed */
    .playground-popup h6 {
        color: #333;
        margin-bottom: 0.5rem;
    }

    .playground-popup p {
        margin-bottom: 0.25rem;
        color: #666;
    }

    .h3-popup h6 {
        color: #333;
        margin-bottom: 0.5rem;
    }

    .h3-popup p {
        margin-bottom: 0.25rem;
        color: #666;
    }

    /* Ensure offcanvas appears above map */
    .offcanvas {
        z-index: 1050;
    }

    /* Custom trigger button positioning */
    .btn[data-bs-toggle="offcanvas"] {
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
</style>
