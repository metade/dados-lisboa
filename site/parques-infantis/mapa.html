---
layout: map
title: "Parques Infantis"
---

<script type="module">
    window.addEventListener("mapReady", (event) => {
        const map = event.detail;

        // Register PMTiles protocol (needed when adding sources manually)
        if (!maplibregl.getProtocol || !maplibregl.getProtocol("pmtiles")) {
            console.log("registering PMTiles protocol");
            const protocol = new pmtiles.Protocol();
            maplibregl.addProtocol("pmtiles", protocol.tile);
        }

        const pmtilesURL =
            "{{ '/assets/data/processed/parques_infantis.pmtiles' | relative_url }}";
        const abs = new URL(pmtilesURL, window.location.origin);
        const thematicURL = "pmtiles://" + abs.pathname + abs.search;

        // Add the PMTiles source (contains both playgrounds and H3 data)
        map.addSource("playgrounds", {
            type: "vector",
            url: thematicURL,
        });

        // Add H3 hexagon layer with distance-based colors and children-based opacity
        map.addLayer({
            id: "h3-hexagons",
            type: "fill",
            source: "playgrounds", // Using the same source
            "source-layer": "h3", // H3 layer within the PMTiles file
            paint: {
                "fill-color": [
                    "case",
                    ["<", ["get", "nearest_playground_distance"], 200],
                    "#27ae60", // Green for < 200m
                    ["<", ["get", "nearest_playground_distance"], 400],
                    "#f1c40f", // Yellow for 200-400m
                    ["<", ["get", "nearest_playground_distance"], 1000],
                    "#e74c3c", // Red for 400-1000m
                    "#9b59b6", // Purple for > 1000m
                ],
                "fill-opacity": [
                    "case",
                    ["==", ["get", "children_under_14"], 0],
                    0, // Transparent when 0 children
                    [
                        "interpolate",
                        ["linear"],
                        ["get", "children_under_14"],
                        1,
                        0.1, // Minimum opacity for 1 child
                        100,
                        0.7, // Adjust this max value based on your actual data
                    ],
                ],
                "fill-outline-color": "#ffffff",
            },
        });

        // Color scheme for different 'gestao' values
        const gestaoColors = {
            JF: "#e74c3c", // Red for Junta de Freguesia
            CML: "#3498db", // Blue for Câmara Municipal de Lisboa
            default: "#95a5a6", // Gray for others
        };

        // Main playground markers (circles colored by gestao)
        map.addLayer({
            id: "playground-circles",
            type: "circle",
            source: "playgrounds",
            "source-layer": "parques_infantis", // "parques_infantis" layer in pmtiles file
            paint: {
                "circle-radius": [
                    "interpolate",
                    ["linear"],
                    ["zoom"],
                    10,
                    4,
                    18,
                    12,
                ],
                "circle-color": [
                    "case",
                    ["==", ["get", "gestao"], "JF"],
                    gestaoColors.JF,
                    ["==", ["get", "gestao"], "CML"],
                    gestaoColors.CML,
                    gestaoColors.default,
                ],
                "circle-stroke-color": "#ffffff",
                "circle-stroke-width": 2,
                "circle-opacity": 0.8,
            },
        });

        // Coffee emoji overlay for playgrounds near quiosques (< 100m)
        map.addLayer({
            id: "playground-coffee",
            type: "symbol",
            source: "playgrounds",
            "source-layer": "parques_infantis",
            filter: ["<", ["get", "distance_from_quiosque"], 100],
            layout: {
                "text-field": "☕",
                "text-size": 16,
                "text-offset": [0, -1.5],
                "text-anchor": "center",
            },
        });

        // Unified click handler to prioritize playground over h3
        // Prevent popups on double-click by using a timeout
        let clickTimeout;
        map.on("click", (e) => {
            // Clear any existing timeout
            if (clickTimeout) {
                clearTimeout(clickTimeout);
            }

            // Set a short timeout to distinguish single clicks from double clicks
            clickTimeout = setTimeout(() => {
                // Query all features at click point
                const features = map.queryRenderedFeatures(e.point);

                // Check if we clicked on a playground first
                const playgroundFeature = features.find(
                    (f) => f.layer.id === "playground-circles",
                );
                if (playgroundFeature) {
                    const properties = playgroundFeature.properties;
                    const coordinates =
                        playgroundFeature.geometry.coordinates.slice();

                    // Ensure popup appears over the feature clicked
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] +=
                            e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    const coffeeText =
                        properties.distance_from_quiosque < 100
                            ? "<p><strong>☕ Quiosque próximo!</strong> (a " +
                              Math.round(properties.distance_from_quiosque) +
                              "m)</p>"
                            : "";

                    const popupHTML = `
                        <div class="playground-popup">
                            <h3>${properties.designacao || "Parque Infantil"}</h3>
                            <p><strong>Morada:</strong> ${properties.morada || "N/A"}</p>
                            <p><strong>Gestão:</strong> ${properties.gestao || "N/A"}</p>
                            <p><strong>Serviço CML:</strong> ${properties.servico_cml || "N/A"}</p>
                            ${coffeeText}
                        </div>
                    `;

                    new maplibregl.Popup()
                        .setLngLat(coordinates)
                        .setHTML(popupHTML)
                        .addTo(map);
                    return; // Exit early, don't check for h3
                }

                // If no playground clicked, check for h3 hexagon
                const h3Feature = features.find(
                    (f) => f.layer.id === "h3-hexagons",
                );
                if (h3Feature) {
                    const properties = h3Feature.properties;
                    const coordinates = e.lngLat;

                    const distanceText = properties.nearest_playground_distance
                        ? `${Math.round(properties.nearest_playground_distance)}m`
                        : "N/A";

                    const popupHTML = `
                        <div class="h3-popup">
                            <h3>Área Residencial</h3>
                            <p><strong>Crianças (< 14 anos):</strong> ${properties.children_under_14 || 0}</p>
                            <p><strong>Distância ao parque mais próximo:</strong> ${distanceText}</p>
                        </div>
                    `;

                    new maplibregl.Popup()
                        .setLngLat(coordinates)
                        .setHTML(popupHTML)
                        .addTo(map);
                }
            }, 200); // 200ms delay to detect double clicks
        });

        // Clear timeout on double click to prevent popup
        map.on("dblclick", () => {
            if (clickTimeout) {
                clearTimeout(clickTimeout);
                clickTimeout = null;
            }
        });

        // Change cursor on hover for hexagons
        map.on("mouseenter", "h3-hexagons", () => {
            map.getCanvas().style.cursor = "pointer";
        });

        map.on("mouseleave", "h3-hexagons", () => {
            map.getCanvas().style.cursor = "";
        });

        // Change cursor on hover for playgrounds (higher priority)
        map.on("mouseenter", "playground-circles", () => {
            map.getCanvas().style.cursor = "pointer";
        });

        map.on("mouseleave", "playground-circles", () => {
            map.getCanvas().style.cursor = "";
        });

        // Dynamic opacity scaling and bounds fitting
        map.on("sourcedata", (e) => {
            if (e.sourceId === "playgrounds" && e.isSourceLoaded) {
                setTimeout(() => {
                    try {
                        // Try to get H3 features to calculate dynamic opacity
                        const h3Features = map.querySourceFeatures(
                            "playgrounds",
                            {
                                sourceLayer: "h3",
                            },
                        );

                        if (h3Features.length > 0) {
                            // Find the maximum children_under_14 value
                            const maxChildren = Math.max(
                                ...h3Features.map(
                                    (f) => f.properties.children_under_14 || 0,
                                ),
                            );

                            console.log("Max children under 14:", maxChildren);

                            // Update the layer paint property with the actual max value
                            if (maxChildren > 0) {
                                map.setPaintProperty(
                                    "h3-hexagons",
                                    "fill-opacity",
                                    [
                                        "case",
                                        ["==", ["get", "children_under_14"], 0],
                                        0, // Transparent when 0 children
                                        [
                                            "interpolate",
                                            ["linear"],
                                            ["get", "children_under_14"],
                                            1,
                                            0.1, // Minimum opacity for 1 child
                                            maxChildren,
                                            0.7, // Maximum opacity for highest value
                                        ],
                                    ],
                                );
                            }
                        }

                        // Also handle playground bounds fitting
                        const playgroundFeatures = map.querySourceFeatures(
                            "playgrounds",
                            {
                                sourceLayer: "parques_infantis",
                            },
                        );

                        if (playgroundFeatures.length > 0) {
                            const bounds = new maplibregl.LngLatBounds();
                            playgroundFeatures.forEach((feature) => {
                                bounds.extend(feature.geometry.coordinates);
                            });
                            map.fitBounds(bounds, { padding: 50 });
                        } else {
                            console.log("no playground features found");
                        }
                    } catch (error) {
                        console.warn("Could not process features:", error);
                    }
                }, 500);
            }
        });
    });
</script>

<style>
    .playground-popup h3 {
        margin: 0 0 10px 0;
        color: #2c3e50;
    }

    .playground-popup p {
        margin: 5px 0;
        font-size: 14px;
    }

    .playground-popup {
        min-width: 0px;
    }

    .h3-popup h3 {
        margin: 0 0 10px 0;
        color: #2c3e50;
    }

    .h3-popup p {
        margin: 5px 0;
        font-size: 14px;
    }

    .h3-popup {
        min-width: 200px;
    }
</style>
