---
layout: map
title: "Parques Infantis"
---

<!-- Menu label and side panel -->
<div id="menu-label" class="menu-label">
    Parques Infantis
    <div id="burger-icon" class="burger-icon">
        <span></span>
        <span></span>
        <span></span>
    </div>
</div>

<div id="side-panel" class="side-panel">
    <div class="side-panel-header">
        <h2>Informação e Filtros</h2>
        <button id="close-panel" class="close-panel">&times;</button>
    </div>
    <div class="side-panel-content">
        <section class="panel-section">
            <h3>Sobre a Visualização</h3>
            <p>
                Este mapa mostra os parques infantis de Lisboa e a sua
                proximidade a quiosques. As áreas residenciais estão coloridas
                por distância ao parque mais próximo.
            </p>
        </section>

        <section class="panel-section">
            <h3>Legenda</h3>
            <h4>Distancia de parques infantis</h4>
            <div class="legend-item">
                <div
                    class="legend-color"
                    style="background-color: #27ae60"
                ></div>
                <span>< 200m do parque</span>
            </div>
            <div class="legend-item">
                <div
                    class="legend-color"
                    style="background-color: #f1c40f"
                ></div>
                <span>200-400m do parque</span>
            </div>
            <div class="legend-item">
                <div
                    class="legend-color"
                    style="background-color: #e74c3c"
                ></div>
                <span>400-1000m do parque</span>
            </div>
            <div class="legend-item">
                <div
                    class="legend-color"
                    style="background-color: #9b59b6"
                ></div>
                <span>> 1000m do parque</span>
            </div>
            <h4>Gestão dos parques infantis</h4>
            <div class="legend-item">
                <div
                    class="legend-color"
                    style="background-color: #e74c3c; border-radius: 50%"
                ></div>
                <span>Parques JF (Junta de Freguesia)</span>
            </div>
            <div class="legend-item">
                <div
                    class="legend-color"
                    style="background-color: #3498db; border-radius: 50%"
                ></div>
                <span>Parques CML (Câmara Municipal)</span>
            </div>
            <div class="legend-item">
                <div
                    class="legend-color"
                    style="background-color: #95a5a6; border-radius: 50%"
                ></div>
                <span>Parques outros</span>
            </div>
            <div class="legend-item">
                <span class="legend-symbol">*</span>
                <span>Quiosque próximo</span>
            </div>
        </section>

        <section class="panel-section">
            <h3>Filtros</h3>
            <p><em>Filtros serão adicionados aqui</em></p>
        </section>
    </div>
</div>

<script type="module">
    window.addEventListener("mapReady", (event) => {
        const map = event.detail;

        // Register PMTiles protocol (needed when adding sources manually)
        if (!maplibregl.getProtocol || !maplibregl.getProtocol("pmtiles")) {
            console.log("registering PMTiles protocol");
            const protocol = new pmtiles.Protocol();
            maplibregl.addProtocol("pmtiles", protocol.tile);
        }

        const pmtilesURL =
            "{{ '/assets/data/processed/parques_infantis.pmtiles' | relative_url }}";
        const abs = new URL(pmtilesURL, window.location.origin);
        const thematicURL = "pmtiles://" + abs.pathname + abs.search;

        // Add the PMTiles source (contains both playgrounds and H3 data)
        map.addSource("playgrounds", {
            type: "vector",
            url: thematicURL,
        });

        // Add H3 hexagon layer with distance-based colors and children-based opacity
        map.addLayer({
            id: "h3-hexagons",
            type: "fill",
            source: "playgrounds", // Using the same source
            "source-layer": "h3", // H3 layer within the PMTiles file
            paint: {
                "fill-color": [
                    "case",
                    ["<", ["get", "nearest_playground_distance"], 200],
                    "#27ae60", // Green for < 200m
                    ["<", ["get", "nearest_playground_distance"], 400],
                    "#f1c40f", // Yellow for 200-400m
                    ["<", ["get", "nearest_playground_distance"], 1000],
                    "#e74c3c", // Red for 400-1000m
                    "#9b59b6", // Purple for > 1000m
                ],
                "fill-opacity": [
                    "case",
                    ["==", ["get", "children_under_14"], 0],
                    0, // Transparent when 0 children
                    [
                        "interpolate",
                        ["linear"],
                        ["get", "children_under_14"],
                        1,
                        0.1, // Minimum opacity for 1 child
                        100,
                        0.7, // Adjust this max value based on your actual data
                    ],
                ],
                "fill-outline-color": "#ffffff",
            },
        });

        // Color scheme for different 'gestao' values
        const gestaoColors = {
            JF: "#e74c3c", // Red for Junta de Freguesia
            CML: "#3498db", // Blue for Câmara Municipal de Lisboa
            default: "#95a5a6", // Gray for others
        };

        // Main playground markers (circles colored by gestao)
        map.addLayer({
            id: "playground-circles",
            type: "circle",
            source: "playgrounds",
            "source-layer": "parques_infantis", // "parques_infantis" layer in pmtiles file
            paint: {
                "circle-radius": [
                    "interpolate",
                    ["linear"],
                    ["zoom"],
                    10,
                    4,
                    18,
                    12,
                ],
                "circle-color": [
                    "case",
                    ["==", ["get", "gestao"], "JF"],
                    gestaoColors.JF,
                    ["==", ["get", "gestao"], "CML"],
                    gestaoColors.CML,
                    gestaoColors.default,
                ],
                "circle-stroke-color": "#ffffff",
                "circle-stroke-width": 2,
                "circle-opacity": 0.8,
            },
        });

        // Coffee indicator for playgrounds near quiosques (< 100m)
        map.addLayer({
            id: "playground-coffee",
            type: "symbol",
            source: "playgrounds",
            "source-layer": "parques_infantis",
            filter: [
                "all",
                ["has", "distance_from_quiosque"],
                ["<", ["get", "distance_from_quiosque"], 100],
            ],
            layout: {
                "text-field": "*",
                "text-size": 16,
                "text-offset": [0, 0.15],
                "text-anchor": "center",
            },
            paint: {
                "text-color": "#FFD700",
                "text-halo-color": "#ffffff",
                "text-halo-width": 2,
            },
        });

        // Unified click handler to prioritize playground over h3
        // Prevent popups on double-click by using a timeout
        let clickTimeout;
        map.on("click", (e) => {
            // Clear any existing timeout
            if (clickTimeout) {
                clearTimeout(clickTimeout);
            }

            // Set a short timeout to distinguish single clicks from double clicks
            clickTimeout = setTimeout(() => {
                // Query all features at click point
                const features = map.queryRenderedFeatures(e.point);

                // Check if we clicked on a playground first
                const playgroundFeature = features.find(
                    (f) => f.layer.id === "playground-circles",
                );
                if (playgroundFeature) {
                    const properties = playgroundFeature.properties;
                    const coordinates =
                        playgroundFeature.geometry.coordinates.slice();

                    // Ensure popup appears over the feature clicked
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] +=
                            e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    const coffeeText =
                        properties.distance_from_quiosque < 100
                            ? "<p><strong>☕ Quiosque próximo!</strong> (a " +
                              Math.round(properties.distance_from_quiosque) +
                              "m)</p>"
                            : "";

                    const popupHTML = `
                        <div class="playground-popup">
                            <h3>${properties.designacao || "Parque Infantil"}</h3>
                            <p><strong>Morada:</strong> ${properties.morada || "N/A"}</p>
                            <p><strong>Gestão:</strong> ${properties.gestao || "N/A"}</p>
                            <p><strong>Serviço CML:</strong> ${properties.servico_cml || "N/A"}</p>
                            ${coffeeText}
                        </div>
                    `;

                    new maplibregl.Popup()
                        .setLngLat(coordinates)
                        .setHTML(popupHTML)
                        .addTo(map);
                    return; // Exit early, don't check for h3
                }

                // If no playground clicked, check for h3 hexagon
                const h3Feature = features.find(
                    (f) => f.layer.id === "h3-hexagons",
                );
                if (h3Feature) {
                    const properties = h3Feature.properties;
                    const coordinates = e.lngLat;

                    const distanceText = properties.nearest_playground_distance
                        ? `${Math.round(properties.nearest_playground_distance)}m`
                        : "N/A";

                    const popupHTML = `
                        <div class="h3-popup">
                            <h3>Área Residencial</h3>
                            <p><strong>Crianças (< 14 anos):</strong> ${properties.children_under_14 || 0}</p>
                            <p><strong>Distância ao parque mais próximo:</strong> ${distanceText}</p>
                        </div>
                    `;

                    new maplibregl.Popup()
                        .setLngLat(coordinates)
                        .setHTML(popupHTML)
                        .addTo(map);
                }
            }, 200); // 200ms delay to detect double clicks
        });

        // Clear timeout on double click to prevent popup
        map.on("dblclick", () => {
            if (clickTimeout) {
                clearTimeout(clickTimeout);
                clickTimeout = null;
            }
        });

        // Change cursor on hover for hexagons
        map.on("mouseenter", "h3-hexagons", () => {
            map.getCanvas().style.cursor = "pointer";
        });

        map.on("mouseleave", "h3-hexagons", () => {
            map.getCanvas().style.cursor = "";
        });

        // Change cursor on hover for playgrounds (higher priority)
        map.on("mouseenter", "playground-circles", () => {
            map.getCanvas().style.cursor = "pointer";
        });

        map.on("mouseleave", "playground-circles", () => {
            map.getCanvas().style.cursor = "";
        });

        // Dynamic opacity scaling and bounds fitting (run only once)
        let hasInitialized = false;
        map.on("sourcedata", (e) => {
            if (
                e.sourceId === "playgrounds" &&
                e.isSourceLoaded &&
                !hasInitialized
            ) {
                hasInitialized = true; // Prevent multiple executions
                setTimeout(() => {
                    try {
                        // Try to get H3 features to calculate dynamic opacity
                        const h3Features = map.querySourceFeatures(
                            "playgrounds",
                            {
                                sourceLayer: "h3",
                            },
                        );

                        if (h3Features.length > 0) {
                            // Find the maximum children_under_14 value
                            const maxChildren = Math.max(
                                ...h3Features.map(
                                    (f) => f.properties.children_under_14 || 0,
                                ),
                            );

                            console.log("Max children under 14:", maxChildren);

                            // Update the layer paint property with the actual max value
                            if (maxChildren > 0) {
                                map.setPaintProperty(
                                    "h3-hexagons",
                                    "fill-opacity",
                                    [
                                        "case",
                                        ["==", ["get", "children_under_14"], 0],
                                        0, // Transparent when 0 children
                                        [
                                            "interpolate",
                                            ["linear"],
                                            ["get", "children_under_14"],
                                            1,
                                            0.1, // Minimum opacity for 1 child
                                            maxChildren,
                                            0.7, // Maximum opacity for highest value
                                        ],
                                    ],
                                );
                            }
                        }

                        // Also handle playground bounds fitting (only once)
                        const playgroundFeatures = map.querySourceFeatures(
                            "playgrounds",
                            {
                                sourceLayer: "parques_infantis",
                            },
                        );

                        if (playgroundFeatures.length > 0) {
                            const bounds = new maplibregl.LngLatBounds();
                            playgroundFeatures.forEach((feature) => {
                                bounds.extend(feature.geometry.coordinates);
                            });
                            // Add animation options to make it smoother
                            map.fitBounds(bounds, {
                                padding: 50,
                                duration: 1000,
                                essential: false,
                            });
                        } else {
                            console.log("no playground features found");
                        }
                    } catch (error) {
                        console.warn("Could not process features:", error);
                    }
                }, 1000); // Increased delay to ensure all data is loaded
            }
        });

        // Menu functionality
        const burgerIcon = document.getElementById("burger-icon");
        const sidePanel = document.getElementById("side-panel");
        const closePanel = document.getElementById("close-panel");

        burgerIcon.addEventListener("click", () => {
            sidePanel.classList.add("open");
        });

        closePanel.addEventListener("click", () => {
            sidePanel.classList.remove("open");
        });

        // Close panel when clicking outside
        document.addEventListener("click", (e) => {
            if (
                !sidePanel.contains(e.target) &&
                !burgerIcon.contains(e.target)
            ) {
                sidePanel.classList.remove("open");
            }
        });
    });
</script>

<style>
    /* Menu label and burger icon */
    .menu-label {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.95);
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 15px;
        font-weight: 600;
        color: #2c3e50;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .menu-label:hover {
        background: rgba(255, 255, 255, 1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .burger-icon {
        display: flex;
        flex-direction: column;
        cursor: pointer;
        padding: 4px;
    }

    .burger-icon span {
        width: 20px;
        height: 2px;
        background-color: #2c3e50;
        margin: 2px 0;
        transition: 0.3s;
        border-radius: 1px;
    }

    .burger-icon:hover span {
        background-color: #3498db;
    }

    /* Side panel */
    .side-panel {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        transition: right 0.3s ease;
        overflow-y: auto;
    }

    .side-panel.open {
        right: 0;
    }

    .side-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
    }

    .side-panel-header h2 {
        margin: 0;
        color: #2c3e50;
        font-size: 18px;
    }

    .close-panel {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #7f8c8d;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .close-panel:hover {
        background: #e74c3c;
        color: white;
    }

    .side-panel-content {
        padding: 20px;
    }

    .panel-section {
        margin-bottom: 30px;
    }

    .panel-section h3 {
        margin: 0 0 15px 0;
        color: #2c3e50;
        font-size: 16px;
        border-bottom: 2px solid #3498db;
        padding-bottom: 5px;
    }

    .panel-section p {
        margin: 0 0 10px 0;
        line-height: 1.5;
        color: #555;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        gap: 10px;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 3px;
        border: 1px solid #ddd;
    }

    .legend-symbol {
        width: 20px;
        text-align: center;
        font-weight: bold;
        color: #ffd700;
    }

    .playground-popup h3 {
        margin: 0 0 10px 0;
        color: #2c3e50;
    }

    .playground-popup p {
        margin: 5px 0;
        font-size: 14px;
    }

    .playground-popup {
        min-width: 0px;
    }

    .h3-popup h3 {
        margin: 0 0 10px 0;
        color: #2c3e50;
    }

    .h3-popup p {
        margin: 5px 0;
        font-size: 14px;
    }

    .h3-popup {
        min-width: 200px;
    }
</style>
