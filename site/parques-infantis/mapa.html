---
layout: map
title: "Parques Infantis"
---

<!-- Bootstrap Offcanvas Trigger Button -->
<button
    class="btn btn-primary position-fixed"
    style="top: 20px; right: 20px; z-index: 1000"
    type="button"
    data-bs-toggle="offcanvas"
    data-bs-target="#sidePanel"
    aria-controls="sidePanel"
>
    <i class="bi bi-list me-2"></i>Parques Infantis
</button>

<!-- Bootstrap Offcanvas Side Panel -->
<div
    class="offcanvas offcanvas-end"
    tabindex="-1"
    id="sidePanel"
    aria-labelledby="sidePanelLabel"
    style="width: 400px"
>
    <div class="offcanvas-header bg-light">
        <h5 class="offcanvas-title" id="sidePanelLabel">
            Informação e Filtros
        </h5>
        <button
            type="button"
            class="btn-close"
            data-bs-dismiss="offcanvas"
            aria-label="Close"
        ></button>
    </div>
    <div class="offcanvas-body">
        <!-- About Section -->
        <div class="mb-4">
            <h6 class="fw-bold mb-3">Sobre a Visualização</h6>
            <p class="small text-muted">
                Este mapa mostra os parques infantis de Lisboa e a sua
                proximidade a quiosques. As áreas residenciais estão coloridas
                por distância ao parque mais próximo.
            </p>
        </div>

        <!-- Legend Section -->
        <div class="mb-4">
            <h6 class="fw-bold mb-3">Legenda</h6>

            <div class="mb-3">
                <h6 class="fs-6 fw-semibold mb-2">
                    Distancia de parques infantis
                </h6>
                <div class="d-flex align-items-center mb-2">
                    <div
                        class="me-2"
                        style="
                            width: 20px;
                            height: 15px;
                            background-color: #27ae60;
                        "
                    ></div>
                    <small>< 200m do parque</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div
                        class="me-2"
                        style="
                            width: 20px;
                            height: 15px;
                            background-color: #f1c40f;
                        "
                    ></div>
                    <small>200-400m do parque</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div
                        class="me-2"
                        style="
                            width: 20px;
                            height: 15px;
                            background-color: #e74c3c;
                        "
                    ></div>
                    <small>400-1000m do parque</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div
                        class="me-2"
                        style="
                            width: 20px;
                            height: 15px;
                            background-color: #9b59b6;
                        "
                    ></div>
                    <small>> 1000m do parque</small>
                </div>
            </div>

            <div class="mb-3">
                <h6 class="fs-6 fw-semibold mb-2">
                    Gestão dos parques infantis
                </h6>
                <div class="d-flex align-items-center mb-2">
                    <div
                        class="me-2 rounded-circle"
                        style="
                            width: 15px;
                            height: 15px;
                            background-color: #e74c3c;
                        "
                    ></div>
                    <small>Parques JF (Junta de Freguesia)</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div
                        class="me-2 rounded-circle"
                        style="
                            width: 15px;
                            height: 15px;
                            background-color: #3498db;
                        "
                    ></div>
                    <small>Parques CML (Câmara Municipal)</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <div
                        class="me-2 rounded-circle"
                        style="
                            width: 15px;
                            height: 15px;
                            background-color: #95a5a6;
                        "
                    ></div>
                    <small>Parques outros</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <span class="me-2 fw-bold">*</span>
                    <small>Quiosque próximo</small>
                </div>
            </div>
        </div>

        <!-- Children Density Section -->
        <div class="mb-4">
            <h6 class="fw-bold mb-3">Densidade de Crianças</h6>
            <div class="d-flex align-items-center mb-2">
                <div
                    class="me-2"
                    style="
                        width: 20px;
                        height: 15px;
                        background-color: #27ae60;
                        opacity: 0.1;
                    "
                ></div>
                <small>Poucas crianças</small>
            </div>
            <div class="d-flex align-items-center mb-2">
                <div
                    class="me-2"
                    style="
                        width: 20px;
                        height: 15px;
                        background-color: #f1c40f;
                        opacity: 0.4;
                    "
                ></div>
                <small>Algumas crianças</small>
            </div>
            <div class="d-flex align-items-center mb-2">
                <div
                    class="me-2"
                    style="
                        width: 20px;
                        height: 15px;
                        background-color: #e74c3c;
                        opacity: 0.7;
                    "
                ></div>
                <small>Muitas crianças</small>
            </div>
            <p class="small text-muted mt-2">
                A intensidade da cor indica o número de crianças (&lt; 14 anos)
                por hexágono.
            </p>
        </div>

        <!-- Filters Section -->
        <div class="mb-4">
            <h6 class="fw-bold mb-3">Filtros</h6>

            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">Freguesias</h6>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            id="select-all-freguesias"
                            checked
                        />
                        <label
                            class="form-check-label fw-semibold"
                            for="select-all-freguesias"
                        >
                            Selecionar todas
                        </label>
                    </div>
                    <div
                        id="freguesias-filter"
                        class="overflow-auto"
                        style="max-height: 200px"
                    >
                        <!-- Freguesia checkboxes will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { singleClickPerFeature } from "/assets/js/core.js";
    import { createFreguesiasFilter } from "/assets/js/freguesia-filter.js";
    import {
        createPopupHTML,
        formatters,
        PopupManager,
    } from "/assets/js/popup-utils.js";

    window.addEventListener("mapReady", (event) => {
        const map = event.detail;

        // Playground-specific popup functions
        function createPlaygroundPopup(properties, coordinates, options = {}) {
            const gestaoLabel =
                properties.gestao === "JF"
                    ? "Junta de Freguesia"
                    : properties.gestao === "CML"
                      ? "Câmara Municipal"
                      : "Outro";

            const fields = [
                {
                    label: "Nome",
                    value:
                        properties.designacao ||
                        properties.nome ||
                        "Parque Infantil",
                    format: formatters.capitalize,
                },
                {
                    label: "Morada",
                    value: properties.morada,
                },
                {
                    label: "Gestão",
                    value: gestaoLabel,
                },
                {
                    label: "Serviço CML",
                    value: properties.servico_cml,
                },
                {
                    label: "Freguesia",
                    value: properties.freguesia,
                    format: formatters.capitalize,
                },
                {
                    label: "Distância ao quiosque mais próximo",
                    value: properties.distance_from_quiosque,
                    format: formatters.distance,
                },
                {
                    label: "Tem quiosque próximo",
                    value: properties.distance_from_quiosque < 100,
                    format: formatters.yesNo,
                },
            ];

            const html = createPopupHTML({
                title: "Parque Infantil",
                fields,
                cssClass: "playground-popup",
            });

            return new maplibregl.Popup().setLngLat(coordinates).setHTML(html);
        }

        function createH3Popup(properties, coordinates, options = {}) {
            const fields = [
                {
                    label: "Distância ao parque mais próximo",
                    value: properties.nearest_playground_distance,
                    format: formatters.distance,
                },
                {
                    label: "Crianças (<14 anos)",
                    value:
                        properties.children_under_14 ||
                        properties.children_count,
                    format: (count) =>
                        formatters.count(count, "criança", "crianças"),
                },
                {
                    label: "Parques na área",
                    value: properties.playground_count,
                    format: (count) =>
                        formatters.count(count, "parque", "parques"),
                },
                {
                    label: "Freguesias",
                    value: properties.freguesias,
                    format: (freguesias) => {
                        if (Array.isArray(freguesias)) {
                            return formatters.list(freguesias);
                        } else if (typeof freguesias === "string") {
                            try {
                                const parsed = JSON.parse(freguesias);
                                return Array.isArray(parsed)
                                    ? formatters.list(parsed)
                                    : freguesias;
                            } catch (e) {
                                return freguesias;
                            }
                        }
                        return formatters.list([]);
                    },
                },
            ];

            const html = createPopupHTML({
                title: "Informação da Área",
                fields,
                cssClass: "h3-popup",
            });

            return new maplibregl.Popup().setLngLat(coordinates).setHTML(html);
        }

        // Initialize popup manager
        const popupManager = new PopupManager(map);

        // Register PMTiles protocol (needed when adding sources manually)
        if (!maplibregl.getProtocol || !maplibregl.getProtocol("pmtiles")) {
            console.log("registering PMTiles protocol");
            const protocol = new pmtiles.Protocol();
            maplibregl.addProtocol("pmtiles", protocol.tile);
        }

        const pmtilesURL =
            "{{ '/assets/data/processed/parques_infantis.pmtiles' | relative_url }}";
        const abs = new URL(pmtilesURL, window.location.origin);
        const thematicURL = "pmtiles://" + abs.pathname + abs.search;

        // Add the PMTiles source (contains both playgrounds and H3 data)
        map.addSource("playgrounds", {
            type: "vector",
            url: thematicURL,
        });

        // Initialize freguesia filter with new module
        let freguesiasFilter;

        // Add H3 hexagon layer with distance-based colors and children-based opacity
        map.addLayer({
            id: "h3-hexagons",
            type: "fill",
            source: "playgrounds", // Using the same source
            "source-layer": "h3", // H3 layer within the PMTiles file
            paint: {
                "fill-color": [
                    "case",
                    ["<", ["get", "nearest_playground_distance"], 200],
                    "#27ae60", // Green for < 200m
                    ["<", ["get", "nearest_playground_distance"], 400],
                    "#f1c40f", // Yellow for 200-400m
                    ["<", ["get", "nearest_playground_distance"], 1000],
                    "#e74c3c", // Red for 400-1000m
                    "#9b59b6", // Purple for > 1000m
                ],
                "fill-opacity": [
                    "case",
                    ["==", ["get", "children_under_14"], 0],
                    0, // Transparent when 0 children
                    [
                        "interpolate",
                        ["linear"],
                        ["get", "children_under_14"],
                        1,
                        0.1, // Minimum opacity for 1 child
                        100,
                        0.7, // Adjust this max value based on your actual data
                    ],
                ],
                "fill-outline-color": "#ffffff",
            },
        });

        // Check for URL parameters and apply initial filter to prevent flash
        const urlParams = new URLSearchParams(window.location.search);
        const urlFreguesias = urlParams.get("freguesias");
        let hasInitialUrlFilter = false;

        if (urlFreguesias) {
            const freguesiasList = urlFreguesias.split(",");
            const initialFilter = [
                "any",
                ...freguesiasList.map((freguesia) => [
                    "in",
                    freguesia,
                    ["get", "freguesias"],
                ]),
            ];
            map.setFilter("h3-hexagons", initialFilter);
            hasInitialUrlFilter = true;

            // Zoom to selected freguesias immediately
            setTimeout(() => {
                try {
                    const allFeatures = map.querySourceFeatures("playgrounds", {
                        sourceLayer: "h3",
                    });

                    const matchingFeatures = allFeatures.filter((feature) => {
                        const freguesias = feature.properties.freguesias;
                        if (!freguesias) return false;

                        if (Array.isArray(freguesias)) {
                            return freguesias.some((f) =>
                                freguesiasList.includes(f),
                            );
                        } else if (typeof freguesias === "string") {
                            try {
                                const parsed = JSON.parse(freguesias);
                                if (Array.isArray(parsed)) {
                                    return parsed.some((f) =>
                                        freguesiasList.includes(f),
                                    );
                                } else {
                                    return freguesiasList.includes(freguesias);
                                }
                            } catch (e) {
                                return freguesiasList.includes(freguesias);
                            }
                        }
                        return false;
                    });

                    if (matchingFeatures.length > 0) {
                        const bounds = new maplibregl.LngLatBounds();
                        matchingFeatures.forEach((feature) => {
                            if (feature.geometry.type === "Polygon") {
                                feature.geometry.coordinates[0].forEach(
                                    (coord) => {
                                        bounds.extend(coord);
                                    },
                                );
                            } else if (
                                feature.geometry.type === "MultiPolygon"
                            ) {
                                feature.geometry.coordinates.forEach(
                                    (polygon) => {
                                        polygon[0].forEach((coord) => {
                                            bounds.extend(coord);
                                        });
                                    },
                                );
                            }
                        });

                        map.fitBounds(bounds, {
                            padding: 50,
                            duration: 1000,
                            essential: false,
                        });
                    }
                } catch (error) {
                    // Silently handle zoom errors
                }
            }, 800);
        }

        // Add playgrounds layer with color based on gestao
        map.addLayer({
            id: "playgrounds",
            type: "circle",
            source: "playgrounds",
            "source-layer": "parques_infantis",
            paint: {
                "circle-radius": [
                    "case",
                    ["==", ["get", "quiosque_proximos"], 1],
                    8, // Larger radius for playgrounds with nearby kiosks
                    6, // Default radius
                ],
                "circle-color": [
                    "case",
                    ["==", ["get", "gestao"], "JF"],
                    "#e74c3c", // Red for JF
                    ["==", ["get", "gestao"], "CML"],
                    "#3498db", // Blue for CML
                    "#95a5a6", // Gray for others
                ],
                "circle-stroke-width": 1,
                "circle-stroke-color": "#ffffff",
            },
        });

        // Add symbol layer for playgrounds with nearby kiosks
        map.addLayer({
            id: "playgrounds-with-kiosks",
            type: "symbol",
            source: "playgrounds",
            "source-layer": "parques_infantis",
            filter: [
                "all",
                ["has", "distance_from_quiosque"],
                ["<", ["get", "distance_from_quiosque"], 100],
            ],
            layout: {
                "text-field": "*",
                "text-font": ["Open Sans Bold", "Arial Unicode MS Bold"],
                "text-size": 14,
                "text-offset": [0, 0.1],
                "text-anchor": "center",
            },
            paint: {
                "text-color": "#FFFFFF",
                "text-halo-color": [
                    "case",
                    ["==", ["get", "gestao"], "JF"],
                    "#e74c3c", // Red for JF
                    ["==", ["get", "gestao"], "CML"],
                    "#3498db", // Blue for CML
                    "#95a5a6", // Gray for others
                ],
                "text-halo-width": 2,
                "text-opacity": 1,
            },
        });

        // Ensure playgrounds are always visible regardless of filter state

        // Add click event for playgrounds
        async function handlePlaygroundClick(e, feature) {
            // Stop event propagation to prevent hexagon popup from also showing
            e.preventDefault();

            const properties = e.features[0].properties;
            const coordinates = e.features[0].geometry.coordinates.slice();

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            // Use the popup utility
            const popup = createPlaygroundPopup(properties, coordinates);
            popupManager.closeCurrentPopup();
            popup.addTo(map);
            popupManager.currentPopup = popup;
        }

        map.on(
            "click",
            "playgrounds",
            singleClickPerFeature(
                handlePlaygroundClick,
                (feature) => feature.id,
            ),
        );

        // Change the cursor to a pointer when the mouse is over the playgrounds layer
        map.on("mouseenter", "playgrounds", () => {
            map.getCanvas().style.cursor = "pointer";
        });

        // Change it back to a pointer when it leaves
        map.on("mouseleave", "playgrounds", () => {
            map.getCanvas().style.cursor = "";
        });

        // Add click event for H3 hexagons
        async function handleH3Click(e, feature) {
            // Check if we clicked on a playground feature at the same location
            const playgroundFeatures = map.queryRenderedFeatures(e.point, {
                layers: ["playgrounds"],
            });

            // If there's a playground at this location, don't show hexagon popup
            if (playgroundFeatures.length > 0) {
                return;
            }

            const properties = e.features[0].properties;
            const coordinates = e.lngLat;

            // Use the popup utility
            const popup = createH3Popup(properties, coordinates);
            popupManager.closeCurrentPopup();
            popup.addTo(map);
            popupManager.currentPopup = popup;
        }

        map.on(
            "click",
            "h3-hexagons",
            singleClickPerFeature(handleH3Click, (feature) => feature.id),
        );

        // Populate freguesias filter after data loads
        let hasInitialized = false;

        // Wait for map to be fully loaded before initializing
        map.on("idle", () => {
            if (!hasInitialized) {
                hasInitialized = true;

                // Initialize freguesias filter
                setTimeout(async () => {
                    try {
                        // Verify data is available
                        const h3Features = map.querySourceFeatures(
                            "playgrounds",
                            {
                                sourceLayer: "h3",
                            },
                        );
                        const playgroundFeatures = map.querySourceFeatures(
                            "playgrounds",
                            {
                                sourceLayer: "parques_infantis",
                            },
                        );

                        if (h3Features.length === 0) {
                            // Show error message in filter container
                            const container =
                                document.getElementById("freguesias-filter");
                            if (container) {
                                container.innerHTML =
                                    '<div class="alert alert-warning small">Nenhuma freguesia encontrada nos dados. Os parques infantis ainda são visíveis no mapa.</div>';
                            }
                            return;
                        }

                        freguesiasFilter = await createFreguesiasFilter({
                            map: map,
                            containerSelector: "#freguesias-filter",
                            selectAllSelector: "#select-all-freguesias",
                            sourceId: "playgrounds",
                            sourceLayer: "h3",
                            layerId: "h3-hexagons",
                            freguesiasProperty: "freguesias",
                            urlParam: "freguesias",
                            onFilterChange: (selectedFreguesias) => {
                                // Always keep playgrounds visible - they should never be filtered
                                map.setFilter("playgrounds", null);
                                if (map.getLayer("playgrounds-with-kiosks")) {
                                    map.setFilter("playgrounds-with-kiosks", [
                                        "all",
                                        ["has", "distance_from_quiosque"],
                                        [
                                            "<",
                                            ["get", "distance_from_quiosque"],
                                            100,
                                        ],
                                    ]);
                                }
                                updateChildrenLegend();
                            },
                            enableZoom: true,
                            skipInitialZoom: hasInitialUrlFilter, // Skip only the initial zoom if we already zoomed
                            enableUrlSync: true,
                        });
                    } catch (error) {
                        // Show error message in filter container
                        const container =
                            document.getElementById("freguesias-filter");
                        if (container) {
                            container.innerHTML = `<div class="alert alert-danger small">Erro ao inicializar filtro: ${error.message}. Os parques infantis ainda são visíveis no mapa.</div>`;
                        }
                    }
                }, 1000); // Increased delay to let initial filter settle
            }
        });

        // Event listeners are now handled by the freguesias filter module
    });

    // Freguesias filter functions

    function updateChildrenLegend() {
        // This function can be expanded to update legend based on visible data
        // For now, it's a placeholder for future enhancements
    }
</script>

<style>
    /* Custom styles to override Bootstrap where needed */
    .playground-popup h6 {
        color: #333;
        margin-bottom: 0.5rem;
    }

    .playground-popup p {
        margin-bottom: 0.25rem;
        color: #666;
    }

    .h3-popup h6 {
        color: #333;
        margin-bottom: 0.5rem;
    }

    .h3-popup p {
        margin-bottom: 0.25rem;
        color: #666;
    }

    /* Ensure offcanvas appears above map */
    .offcanvas {
        z-index: 1050;
    }

    /* Custom trigger button positioning */
    .btn[data-bs-toggle="offcanvas"] {
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
</style>
