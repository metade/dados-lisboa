---
layout: map
title: "Parques Infantis"
---

<script type="module">
    window.addEventListener("mapReady", (event) => {
        const map = event.detail;

        // Register PMTiles protocol (needed when adding sources manually)
        if (!maplibregl.getProtocol || !maplibregl.getProtocol("pmtiles")) {
            console.log("registering PMTiles protocol");
            const protocol = new pmtiles.Protocol();
            maplibregl.addProtocol("pmtiles", protocol.tile);
        }

        const pmtilesURL =
            "{{ '/assets/data/processed/parques_infantis.pmtiles' | relative_url }}";
        const abs = new URL(pmtilesURL, window.location.origin);
        const thematicURL = "pmtiles://" + abs.pathname + abs.search;

        // Add the PMTiles source
        map.addSource("playgrounds", {
            type: "vector",
            url: thematicURL,
        });

        // Color scheme for different 'gestao' values
        const gestaoColors = {
            JF: "#e74c3c", // Red for Junta de Freguesia
            CML: "#3498db", // Blue for Câmara Municipal de Lisboa
            default: "#95a5a6", // Gray for others
        };

        // Main playground markers (circles colored by gestao)
        map.addLayer({
            id: "playground-circles",
            type: "circle",
            source: "playgrounds",
            "source-layer": "parques_infantis", // Make sure this matches your PMTiles layer name
            paint: {
                "circle-radius": [
                    "interpolate",
                    ["linear"],
                    ["zoom"],
                    10,
                    4,
                    18,
                    12,
                ],
                "circle-color": [
                    "case",
                    ["==", ["get", "gestao"], "JF"],
                    gestaoColors.JF,
                    ["==", ["get", "gestao"], "CML"],
                    gestaoColors.CML,
                    gestaoColors.default,
                ],
                "circle-stroke-color": "#ffffff",
                "circle-stroke-width": 2,
                "circle-opacity": 0.8,
            },
        });

        // Coffee emoji overlay for playgrounds near quiosques (< 100m)
        map.addLayer({
            id: "playground-coffee",
            type: "symbol",
            source: "playgrounds",
            "source-layer": "parques",
            filter: ["<", ["get", "distance_from_quiosque"], 100],
            layout: {
                "text-field": "☕",
                "text-size": 16,
                "text-offset": [0, -1.5],
                "text-anchor": "center",
            },
        });

        // Popup functionality
        map.on("click", "playground-circles", (e) => {
            const properties = e.features[0].properties;
            const coordinates = e.features[0].geometry.coordinates.slice();

            // Ensure popup appears over the feature clicked
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            const coffeeText =
                properties.distance_from_quiosque < 100
                    ? "<p><strong>☕ Quiosque próximo!</strong> (a " +
                      Math.round(properties.distance_from_quiosque) +
                      "m)</p>"
                    : "";

            const popupHTML = `
                <div class="playground-popup">
                    <h3>${properties.designacao || "Parque Infantil"}</h3>
                    <p><strong>Morada:</strong> ${properties.morada || "N/A"}</p>
                    <p><strong>Gestão:</strong> ${properties.gestao || "N/A"}</p>
                    <p><strong>Serviço CML:</strong> ${properties.servico_cml || "N/A"}</p>
                    ${coffeeText}
                </div>
            `;

            new maplibregl.Popup()
                .setLngLat(coordinates)
                .setHTML(popupHTML)
                .addTo(map);
        });

        // Change cursor on hover
        map.on("mouseenter", "playground-circles", () => {
            map.getCanvas().style.cursor = "pointer";
        });

        map.on("mouseleave", "playground-circles", () => {
            map.getCanvas().style.cursor = "";
        });

        // Fit map to show all playgrounds
        map.on("sourcedata", (e) => {
            if (e.sourceId === "playgrounds" && e.isSourceLoaded) {
                // Wait a bit for the source to be fully loaded
                setTimeout(() => {
                    try {
                        const allFeatures =
                            map.querySourceFeatures("playgrounds");
                        console.log(
                            "All features in source:",
                            allFeatures.length,
                            allFeatures,
                        );

                        const features = map.querySourceFeatures(
                            "playgrounds",
                            {
                                sourceLayer: "parques",
                            },
                        );

                        if (features.length > 0) {
                            const bounds = new maplibregl.LngLatBounds();
                            features.forEach((feature) => {
                                bounds.extend(feature.geometry.coordinates);
                            });
                            map.fitBounds(bounds, { padding: 50 });
                        } else {
                            console.log("no features");
                        }
                    } catch (error) {
                        console.warn(
                            "Could not fit bounds to playgrounds:",
                            error,
                        );
                    }
                }, 500);
            }
        });
    });
</script>

<style>
    .playground-popup h3 {
        margin: 0 0 10px 0;
        color: #2c3e50;
    }

    .playground-popup p {
        margin: 5px 0;
        font-size: 14px;
    }

    .playground-popup {
        min-width: 250px;
    }
</style>
